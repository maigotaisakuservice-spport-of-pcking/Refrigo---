<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Refrigo - å†·è”µåº«ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- LINE Login SDK / Firebase / OCR -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 600px; margin: auto; }
    h2 { margin-top: 2rem; }
    input, button, textarea { margin: 0.5rem 0; padding: 0.5rem; width: 100%; }
    .item { border-bottom: 1px solid #ccc; padding: 0.5rem 0; }
    .tab { display: none; }
    .tab.active { display: block; }
    .nav { display: flex; gap: 1rem; margin-bottom: 1rem; }
    .nav button { flex: 1; padding: 0.5rem; }
  </style>
</head>
<body>
  <h1>Refrigo - å†·è”µåº«ç®¡ç†</h1>

  <div id="loginStatus">LINEãƒ­ã‚°ã‚¤ãƒ³ä¸­...</div>

  <div class="nav">
    <button onclick="switchTab('fridge')">å†·è”µåº«</button>
    <button onclick="switchTab('add')">è¿½åŠ </button>
    <button onclick="switchTab('ocr')">OCR</button>
    <button onclick="switchTab('shopping')">è²·ã„ç‰©</button>
  </div>

  <div id="fridge" class="tab active">
    <h2>å†·è”µåº«ã®ä¸­èº«</h2>
    <div id="fridgeList"></div>
  </div>

  <div id="add" class="tab">
    <h2>æ‰‹å‹•è¿½åŠ </h2>
    <input type="text" id="nameInput" placeholder="é£Ÿæå">
    <input type="date" id="dateInput">
    <input type="number" id="qtyInput" placeholder="æ•°é‡" min="1" value="1">
    <button onclick="addItem()">è¿½åŠ </button>
  </div>

  <div id="ocr" class="tab">
    <h2>OCRç™»éŒ²</h2>
    <input type="file" id="ocrInput" accept="image/*">
    <div id="ocrResult"></div>
    <button onclick="processOCR()">OCRå®Ÿè¡Œ</button>
  </div>

  <div id="shopping" class="tab">
    <h2>è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h2>
    <input type="text" id="shoppingInput" placeholder="è²·ã†ã‚‚ã®">
    <button onclick="addToShopping()">è¿½åŠ </button>
    <div id="shoppingList"></div>
  </div>

  <script>
    const firebaseConfig = {
    apiKey: "AIzaSyA8fBI_oR1WVSvN7SUk2yh5G0UJ-DIb76s",
    authDomain: "refrigo-refrigeratormanagement.firebaseapp.com",
    projectId: "refrigo-refrigeratormanagement",
    storageBucket: "refrigo-refrigeratormanagement.firebasestorage.app",
    messagingSenderId: "455556562672",
    appId: "1:455556562672:web:9c61c42c49467938724c35",
    measurementId: "G-JJLSNQ4GBG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let userId = null;

    // LINEãƒ­ã‚°ã‚¤ãƒ³
    liff.init({ liffId: "2007687029-kBrn695e" }).then(() => {
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        liff.getProfile().then(profile => {
          userId = profile.userId;
          document.getElementById("loginStatus").innerText = "ã“ã‚“ã«ã¡ã¯ " + profile.displayName;
          loadFridge();
          loadShoppingList();
        });
      }
    });

    // ã‚¿ãƒ–åˆ‡æ›¿
    function switchTab(tab) {
      document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
      document.getElementById(tab).classList.add("active");
    }

    // å†·è”µåº«è¿½åŠ 
    function addItem() {
      const name = document.getElementById("nameInput").value;
      const date = document.getElementById("dateInput").value;
      const qty = parseInt(document.getElementById("qtyInput").value);
      if (!name || !date || !qty) return alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");

      db.collection("users").doc(userId).collection("fridge").add({
        name, date, qty, created: new Date()
      }).then(() => {
        loadFridge();
        alert("è¿½åŠ ã•ã‚Œã¾ã—ãŸ");
      });
    }

    // å†·è”µåº«ä¸€è¦§å–å¾—
    function loadFridge() {
      db.collection("users").doc(userId).collection("fridge").orderBy("date").get().then(snapshot => {
        const container = document.getElementById("fridgeList");
        container.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `${data.name} (${data.qty}) - ${data.date}
            <button onclick="deleteItem('${doc.id}')">å‰Šé™¤</button>`;
          container.appendChild(div);
        });
      });
    }

    function deleteItem(id) {
      db.collection("users").doc(userId).collection("fridge").doc(id).delete().then(loadFridge);
    }

    // è²·ã„ç‰©ãƒªã‚¹ãƒˆè¿½åŠ 
    function addToShopping() {
      const name = document.getElementById("shoppingInput").value;
      if (!name) return;
      db.collection("users").doc(userId).collection("shopping").add({
        name, created: new Date()
      }).then(() => {
        loadShoppingList();
        document.getElementById("shoppingInput").value = "";
      });
    }

    function loadShoppingList() {
      db.collection("users").doc(userId).collection("shopping").orderBy("created").get().then(snapshot => {
        const container = document.getElementById("shoppingList");
        container.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `${data.name}
            <button onclick="checkItem('${doc.id}', '${data.name}')">ãƒã‚§ãƒƒã‚¯</button>`;
          container.appendChild(div);
        });
      });
    }

    function checkItem(id, name) {
      // è²·ã„ç‰©ãƒã‚§ãƒƒã‚¯ â†’ å†·è”µåº«ã«è¿½åŠ 
      db.collection("users").doc(userId).collection("fridge").add({
        name, date: new Date().toISOString().slice(0,10), qty: 1, created: new Date()
      });
      db.collection("users").doc(userId).collection("shopping").doc(id).delete().then(loadShoppingList);
    }

    // OCRå‡¦ç†
    function processOCR() {
  const input = document.getElementById("ocrInput");
  if (!input.files[0]) return alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");

  Tesseract.recognize(input.files[0], 'jpn').then(({ data: { text } }) => {
    const lines = text.split('\n').map(t => t.trim()).filter(t => t);
    document.getElementById("ocrResult").innerText = lines.join('\n');

    const detectedItems = [];

    lines.filter(line => /\d{4}[-\/.]\d{2}[-\/.]\d{2}/.test(line)).forEach(line => {
      const parts = line.split(/\s+/);
      if (parts.length >= 2) {
        const name = parts[0];
        const date = parts[1].replace(/[./]/g, '-');
        const item = { name, date, qty: 1, created: new Date() };
        detectedItems.push(item);

        db.collection("users").doc(userId).collection("fridge").add(item);
      }
    });

    // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
    const msg = detectedItems.map((item, i) =>
      `${i + 1}. ${item.name}ï¼ˆæœŸé™: ${item.date}ï¼‰`
    ).join('\n');

    fetch("https://YOUR_SERVER/notify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: userId,
        message: `ğŸ“¦ OCRã§ä»¥ä¸‹ã®é£ŸæãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸ:\n${msg}`
      })
    });
  });
}
  </script>
</body>
</html>
